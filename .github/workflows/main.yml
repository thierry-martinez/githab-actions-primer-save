name: main
on: [push]
jobs:
  check-image-changed:
    runs-on: ubuntu-latest
    outputs:
      image_changed: ${{ steps.check-changed.outputs.image-changed}}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - id: check-changed
        name: Check changed
        run: |
          if git diff --quiet --exit-code HEAD^ HEAD -- \
            dockerfiles/ros-humble/Dockerfile; then
            changed=0
          else
            changed=1
          fi
          echo "Has changed: $changed"
          echo "::set-output name=image-changed::$changed"
  build-image:
    runs-on: ubuntu-latest
    needs: [check-image-changed]
    steps:
      - name: Echo image changed
        run: |
          echo Changed: ${{ needs.check-image-changed.outputs.image-changed }}
      - name: Checkout
        uses: actions/checkout@v3
      - name: Build
        run: |
          docker build -t ghcr.io/thierry-martinez/ros-humble \
            dockerfiles/ros-humble
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.packages_write }}
      - name: Push
        run: |
          docker push ghcr.io/thierry-martinez/ros-humble
  build:
    runs-on: ubuntu-22.04
    needs: [build-image]
    if: always() && (needs.build-image.result == 'success' || needs.build-image.result == 'skipped')
    container:
      image: ghcr.io/thierry-martinez/ros-humble
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.packages_read }}
    steps:
      - name: Talker/listener example
        run: |
          . /opt/ros/humble/setup.sh
          ros2 run demo_nodes_cpp talker &
          ros2 run demo_nodes_cpp listener &
          sleep 1 && killall ros2
